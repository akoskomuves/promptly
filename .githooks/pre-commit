#!/bin/bash
# Pre-commit hook to prevent committing private files to the public repo

# List of files that should NEVER be in the public repo
PRIVATE_FILES=(
  "CLAUDE.md"
  "ROADMAP.md"
  "TECHSTACK.md"
  "BUSINESS.md"
  ".env"
  ".env.local"
  ".env.production"
)

# List of directories that should NEVER be committed
PRIVATE_DIRS=(
  "cloud/"
  "landing/"
)

# Check staged files
STAGED_FILES=$(git diff --cached --name-only)

for file in "${PRIVATE_FILES[@]}"; do
  if echo "$STAGED_FILES" | grep -q "^${file}$"; then
    echo "❌ ERROR: Attempting to commit private file: $file"
    echo ""
    echo "This file should only be in the private repo (cloud/)."
    echo "It's already in .gitignore - did you force-add it?"
    echo ""
    echo "To unstage: git reset HEAD $file"
    exit 1
  fi
done

for dir in "${PRIVATE_DIRS[@]}"; do
  if echo "$STAGED_FILES" | grep -q "^${dir}"; then
    echo "❌ ERROR: Attempting to commit files from private directory: $dir"
    echo ""
    echo "This directory should only be in the private repo."
    echo "It's already in .gitignore - did you force-add it?"
    echo ""
    exit 1
  fi
done

# Check for potential secrets in staged files
if git diff --cached | grep -iE "(api_key|secret_key|password|token).*=.*['\"][^'\"]{8,}['\"]" | grep -v "example\|placeholder\|changeme\|your-"; then
  echo "⚠️  WARNING: Potential secrets detected in staged changes"
  echo ""
  echo "Please review the above matches before committing."
  echo "To proceed anyway: git commit --no-verify"
  echo ""
  exit 1
fi

exit 0
